<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ignacio y Lucía | Nuestra Boda</title>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Raleway:wght@300;400;600&family=Great+Vibes&display=swap"
        rel="stylesheet">

    <!-- Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .phone-link {
            text-decoration: none;
            color: inherit;
            font-weight: normal;
        }

        .phone-link:hover {
            color: var(--color-accent);
            text-decoration: underline;
        }

        .carousel-item {
            cursor: pointer;
        }
    </style>
</head>

<body>

    <!-- Navegación -->
    <div class="nav-container">
        <nav>
            <div class="logo">I & L</div>
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
            </button>
            <ul class="nav-links" id="navLinks">
                <li><a href="#hero">Inicio</a></li>
                <li><a href="#our-story">Nuestra Historia</a></li>
                <li><a href="#wedding-details">Detalles</a></li>
                <li><a href="#guestbook">Libro de Firmas</a></li>
            </ul>
        </nav>
    </div>

    <!-- Header / Hero (Parallax) -->
    <header id="hero">
        <div class="hero-bg" id="heroBg"></div>
        <div class="hero-overlay"></div>

        <div class="header-content" data-aos="fade-up" data-aos-duration="1500">
            <h1 class="couple-names">
                Ignacio <span>&</span> Lucía
            </h1>
            <p class="wedding-date">9 de Octubre, 2027</p>
        </div>

        <a href="#countdown" class="scroll-indicator">
            <i class="fas fa-chevron-down"></i>
        </a>
    </header>

    <!-- Cuenta Regresiva -->
    <section id="countdown">
        <div data-aos="fade-up">
            <h2 class="section-title">Solo faltan...</h2>
            <div class="countdown-container">
                <div class="countdown-item">
                    <span class="countdown-number" id="days">00</span>
                    <span class="countdown-label">Días</span>
                </div>
                <div class="countdown-item">
                    <span class="countdown-number" id="hours">00</span>
                    <span class="countdown-label">Horas</span>
                </div>
                <div class="countdown-item">
                    <span class="countdown-number" id="minutes">00</span>
                    <span class="countdown-label">Min</span>
                </div>
                <div class="countdown-item">
                    <span class="countdown-number" id="seconds">00</span>
                    <span class="countdown-label">Seg</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Nuestra Historia -->
    <section id="our-story">
        <h2 class="section-title" data-aos="fade-up">Nuestra Historia</h2>

        <!-- Part 1: The Beginning -->
        <div class="story-block" data-aos="fade-right">
            <div class="story-text">
                <h3>Un Encuentro Inesperado</h3>
                <p>Hace ya algunos años, en vísperas del Carnaval, el destino nos cruzó de manera inesperada. Sin
                    buscarlo, sin planearlo, nos encontramos y descubrimos en el otro aquello que nunca imaginamos:
                    nuestro refugio.</p>
                <p>Lo que empezó como una simple conversación y encuentros casuales, pronto se transformó en una
                    conexión profunda y única, capaz de cambiar para siempre el rumbo de nuestras vidas.</p>
            </div>
            <div class="story-image-wrap">
                <img src="https://images.unsplash.com/photo-1511285560929-80b456fea0bc?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                    alt="Pareja">
            </div>
        </div>

        <!-- Part 2: The Proposal -->
        <div class="story-block reversed" data-aos="fade-left">
            <div class="story-text">
                <h3>La Promesa</h3>
                <p>Tras 8 años y medio de compartir sueños, risas y aventuras, Ignacio me sorprendió. En un viaje
                    inolvidable a Almuñécar, frente al mar y bajo la magia de un atardecer que parecía escrito para
                    nosotros, hizo la pregunta.</p>
                <p>Fue, sin duda, el instante más mágico de nuestra historia. Y hoy, con la misma ilusión, queremos
                    compartir nuestra felicidad con todos ustedes.</p>
            </div>
            <div class="story-image-wrap">
                <img src="https://images.unsplash.com/photo-1515934751635-c81c6bc9a2d8?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
                    alt="Anillo Compromiso">
            </div>
        </div>

        <!-- Gallery Carousel -->
        <div class="row mt-5" data-aos="zoom-in">
            <div class="col-md-8 mx-auto">
                <div id="storyCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item active" onclick="openLightbox(this)">
                            <img src="https://images.unsplash.com/photo-1519741497674-611481863552?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80"
                                class="d-block w-100" alt="Foto">
                            <div class="carousel-caption d-none d-md-block">
                                <span class="badge bg-dark bg-opacity-50"><i class="fas fa-expand"></i> Ver pantalla
                                    completa</span>
                            </div>
                        </div>
                        <div class="carousel-item" onclick="openLightbox(this)">
                            <img src="https://images.unsplash.com/photo-1465495976277-4387d4b0b4c6?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80"
                                class="d-block w-100" alt="Foto">
                            <div class="carousel-caption d-none d-md-block">
                                <span class="badge bg-dark bg-opacity-50"><i class="fas fa-expand"></i> Ver pantalla
                                    completa</span>
                            </div>
                        </div>
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#storyCarousel"
                        data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#storyCarousel"
                        data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    </button>
                </div>
                <p class="text-center mt-2 text-muted small"><i class="fas fa-hand-pointer"></i> Haz clic en la imagen
                    para ampliar</p>
            </div>
        </div>
    </section>

    <!-- Detalles -->
    <section id="wedding-details" style="background-color: var(--color-surface);">
        <h2 class="section-title" data-aos="fade-up">Detalles del Evento</h2>

        <div class="details-grid">
            <!-- Ceremonia -->
            <div class="detail-card" data-aos="fade-up" data-aos-delay="100">
                <div class="detail-icon"><i class="fas fa-church"></i></div>
                <h3 class="detail-title">Ceremonia</h3>
                <div class="detail-info">Ceremonia Civil en Salones María Luisa</div>
                <div class="detail-info">12:00 horas</div>
                <a href="https://www.google.com/maps/search/?api=1&query=Salones+María+Luisa+Torredonjimeno"
                    target="_blank" class="map-link">Ver Mapa</a>
            </div>

            <!-- Recepción -->
            <div class="detail-card" data-aos="fade-up" data-aos-delay="200">
                <div class="detail-icon"><i class="fas fa-glass-cheers"></i></div>
                <h3 class="detail-title">Recepción</h3>
                <div class="detail-info">Salones María Luisa</div>
                <div class="detail-info">14:00 horas</div>
                <a href="https://www.google.com/maps/search/?api=1&query=Salones+María+Luisa+Torredonjimeno"
                    target="_blank" class="map-link">Ver Mapa</a>
            </div>

            <!-- RSVP -->
            <div class="detail-card" data-aos="fade-up" data-aos-delay="300">
                <div class="detail-icon"><i class="fas fa-mobile-alt"></i></div>
                <h3 class="detail-title">Confirmar</h3>

                <div class="contact-info-block" style="margin-bottom: 1rem;">
                    <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
                        <span class="fw-bold">Ignacio:</span>
                        <a href="tel:678022642" class="phone-link" title="Llamar">
                            <i class="fas fa-phone-alt"></i> 678 022 642
                        </a>
                        <a href="https://wa.me/34678022642?text=Hola%20Ignacio,%20quiero%20confirmar%20mi%20asistencia%20a%20la%20boda.%20%C2%A1Nos%20vemos%20all%C3%AD!"
                            target="_blank" class="whatsapp-btn" title="Enviar WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                    </div>
                    <div class="d-flex justify-content-center align-items-center gap-2">
                        <span class="fw-bold">Lucía:</span>
                        <a href="tel:678073149" class="phone-link" title="Llamar">
                            <i class="fas fa-phone-alt"></i> 678 073 149
                        </a>
                        <a href="https://wa.me/34678073149?text=Hola%20Luc%C3%ADa,%20quiero%20confirmar%20mi%20asistencia%20a%20la%20boda.%20%C2%A1Nos%20vemos%20all%C3%AD!"
                            target="_blank" class="whatsapp-btn" title="Enviar WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                    </div>
                </div>

                <div class="detail-info" style="font-size: 0.8rem; margin-top: 15px;">
                    ¿Tienes alergias?
                    <button type="button" class="btn btn-link p-0" data-bs-toggle="modal" data-bs-target="#allergyModal"
                        style="color: var(--color-accent); font-size: 0.8rem; text-decoration: none;">
                        Infórmanos aquí
                    </button>
                    <i class="fas fa-info-circle" style="color: var(--color-accent); cursor: pointer;"
                        data-bs-toggle="modal" data-bs-target="#allergyModal"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- Libro de Firmas -->
    <section id="guestbook">
        <div data-aos="fade-up">
            <h2 class="section-title">Libro de Firmas</h2>

            <form class="guestbook-form" action="/agregar-mensaje" method="POST">
                <div class="form-group">
                    <label for="name">Tu Nombre</label>
                    <input type="text" id="name" name="nombre" required placeholder="Escribe tu nombre... ">
                </div>
                <div class="form-group">
                    <label for="message">Tus Deseos</label>
                    <textarea id="message" name="mensaje" required
                        placeholder="Déjanos un mensaje bonito..."></textarea>
                </div>
                <button type="submit" class="btn-submit">Enviar Mensaje</button>
            </form>

            <div class="messages-grid">
                {% if mensajes %}
                {% for mensaje in mensajes %}
                <div class="message-card position-relative">
                    <div class="message-actions"
                        style="position: absolute; top: 15px; right: 15px; display: flex; gap: 10px;">
                        <!-- Edit Button -->
                        <!-- Edit Button -->
                        <i class="fas fa-edit text-primary cursor-pointer me-2"
                            onclick="openEditModal('{{ mensaje.nombre }}', '{{ mensaje.mensaje }}')" title="Editar"></i>
                        <!-- Delete Button -->
                        <!-- Delete Button -->
                        <i class="fas fa-trash-alt text-danger cursor-pointer"
                            onclick="deleteMessage('{{ mensaje.nombre }}', this)" title="Borrar"></i>
                    </div>
                    <div class="message-header pe-5">
                        <span class="msg-author">{{ mensaje.nombre }}</span>
                        <span class="msg-date">{{ mensaje.fecha }}</span>
                    </div>
                    <div class="msg-body">"{{ mensaje.mensaje }}"</div>
                </div>
                {% endfor %}
                {% else %}
                <p style="grid-column: 1/-1; text-align: center; color: #999;">Sé el primero en firmar nuestro libro.
                </p>
                {% endif %}
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <h2 class="footer-names">Ignacio & Lucía</h2>
        <p>Gracias por acompañarnos en este día tan especial.</p>
    </footer>

    <!-- Modals -->

    <!-- Allergy Modal -->
    <div class="modal fade" id="allergyModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: var(--color-surface);">
                <div class="modal-header border-0">
                    <h5 class="modal-title" style="font-family: var(--font-heading);">Información sobre Alergias</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Queremos que todos disfruten del banquete con total tranquilidad.</p>
                    <p>Por favor, al confirmar tu asistencia por teléfono, indícanos si tienes alguna alergia
                        alimentaria, intolerancia o sigues alguna dieta especial (vegetariana, vegana, celíaca, etc.).
                    </p>
                    <p class="text-center mt-3" style="color: var(--color-accent-dark); font-weight: bold;">
                        ¡Nos encargaremos de que tengas un menú delicioso y seguro!
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div class="modal fade" id="lightboxModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content bg-transparent border-0 shadow-none">
                <div
                    class="modal-body p-0 text-center position-relative d-flex align-items-center justify-content-center">
                    <button type="button"
                        class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3 bg-white"
                        data-bs-dismiss="modal" aria-label="Close"></button>

                    <!-- Navigation Buttons -->
                    <button class="btn btn-link text-white position-absolute start-0 ms-2 z-3"
                        onclick="navigateLightbox(-1)" style="font-size: 2rem;">
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <img src="" id="lightboxImage" class="img-fluid rounded shadow-lg" style="max-height: 90vh;">

                    <button class="btn btn-link text-white position-absolute end-0 me-2 z-3"
                        onclick="navigateLightbox(1)" style="font-size: 2rem;">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Message Modal -->
    <div class="modal fade" id="editMessageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Mensaje</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action="/editar-mensaje" method="POST" id="editForm">
                        <input type="hidden" name="nombre_original" id="editOriginalName">
                        <div class="mb-3">
                            <label for="editNombre" class="form-label">Tu Nombre</label>
                            <input type="text" class="form-control" id="editNombre" name="nombre" required>
                        </div>
                        <div class="mb-3">
                            <label for="editMensaje" class="form-label">Mensaje</label>
                            <textarea class="form-control" id="editMensaje" name="mensaje" rows="4" required></textarea>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary"
                                style="background-color: var(--color-accent); border: none;">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        // Init AOS
        AOS.init({
            once: true,
            offset: 100
        });

        // Parallax Effect
        window.addEventListener('scroll', function () {
            const scrolled = window.pageYOffset;
            const heroBg = document.getElementById('heroBg');
            if (heroBg) heroBg.style.transform = 'translateY(' + (scrolled * 0.5) + 'px)';
        });

        // Countdown
        function updateCountdown() {
            const weddingDate = new Date('October 9, 2027 16:00:00').getTime();
            const now = new Date().getTime();
            const timeLeft = weddingDate - now;

            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            if (document.getElementById('days')) {
                document.getElementById('days').textContent = String(days).padStart(2, '0');
                document.getElementById('hours').textContent = String(hours).padStart(2, '0');
                document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
                document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
            }
        }

        setInterval(updateCountdown, 1000);
        updateCountdown();

        // Mobile Menu
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const navLinks = document.getElementById('navLinks');

        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                navLinks.classList.toggle('active');

                // Change icon based on state
                const icon = mobileMenuBtn.querySelector('i');
                if (navLinks.classList.contains('active')) {
                    icon.classList.remove('fa-bars');
                    icon.classList.add('fa-times');
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                }
            });

            // Close menu when a link is clicked
            document.querySelectorAll('.nav-links a').forEach(link => {
                link.addEventListener('click', () => {
                    navLinks.classList.remove('active');
                    const icon = mobileMenuBtn.querySelector('i');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-bars');
                });
            });
        }

        // Lightbox Function
        let currentImageIndex = 0;
        const carouselImages = [];

        // Initialize images array on load
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.carousel-item img').forEach((img, index) => {
                carouselImages.push(img.src);
            });
        });


        // AJAX Guestbook Handling
        document.addEventListener('DOMContentLoaded', () => {
            // Add Message
            const addForm = document.querySelector('.guestbook-form');
            if (addForm) {
                addForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(addForm);

                    try {
                        const response = await fetch('/agregar-mensaje', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();

                        if (data.success) {
                            // Create new message card
                            const grid = document.querySelector('.messages-grid');
                            const newCard = document.createElement('div');
                            newCard.className = 'message-card position-relative'; // Added position-relative for consistency
                            newCard.style.animation = 'fadeIn 1s ease';

                            // Generate HTML (replicating template logic)
                            newCard.innerHTML = `
                                <div class="message-actions"
                                    style="position: absolute; top: 15px; right: 15px; display: flex; gap: 10px;">
                                    <i class="fas fa-edit text-primary cursor-pointer me-2" 
                                        onclick="openEditModal('${data.nombre}', '${data.mensaje}')" 
                                        title="Editar"></i>
                                    <i class="fas fa-trash-alt text-danger cursor-pointer" 
                                        onclick="deleteMessage('${data.nombre}', this)" 
                                        title="Borrar"></i>
                                </div>
                                <div class="message-header pe-5">
                                    <span class="msg-author">${data.nombre}</span>
                                    <span class="msg-date">${data.fecha}</span>
                                </div>
                                <div class="msg-body">"${data.mensaje}"</div>
                            `;

                            // Insert at the beginning
                            if (grid.querySelector('p')) {
                                // If "be the first" text exists, replace it
                                grid.innerHTML = '';
                                grid.appendChild(newCard);
                            } else {
                                grid.insertBefore(newCard, grid.firstChild);
                            }

                            addForm.reset();
                        }
                    } catch (err) {
                        console.error('Error adding message:', err);
                    }
                });
            }

            // Edit Message
            const editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(editForm);
                    const originalName = document.getElementById('editOriginalName').value;

                    try {
                        const response = await fetch('/editar-mensaje', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();

                        if (data.success) {
                            // Find the card and update it directly
                            // Searching by author name isn't perfect if duplicates exist, but consistent with current logic
                            const authors = document.querySelectorAll('.msg-author');
                            for (let author of authors) {
                                if (author.textContent === originalName) {
                                    const card = author.closest('.message-card');
                                    author.textContent = data.nombre;
                                    card.querySelector('.msg-body').textContent = `"${data.mensaje}"`;

                                    // Update onclick handlers for next edit/delete
                                    const editBtn = card.querySelector('.fa-edit');
                                    const deleteBtn = card.querySelector('.fa-trash-alt');

                                    editBtn.setAttribute('onclick', `openEditModal('${data.nombre}', '${data.mensaje}')`);
                                    deleteBtn.setAttribute('onclick', `deleteMessage('${data.nombre}', this)`);

                                    // Close modal
                                    const modal = bootstrap.Modal.getInstance(document.getElementById('editMessageModal'));
                                    modal.hide();
                                    break;
                                }
                            }
                        }
                    } catch (err) {
                        console.error('Error editing message:', err);
                    }
                });
            }
        });

        // Delete Message Function (AJAX)
        async function deleteMessage(nombre, element) {
            if (!confirm('¿Seguro que quieres borrar este mensaje?')) return;

            const formData = new FormData();
            formData.append('nombre', nombre);

            try {
                const response = await fetch('/borrar-mensaje', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    // Fade out and remove
                    const card = element.closest('.message-card');
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';

                    setTimeout(() => {
                        card.remove();
                    }, 500);
                }
            } catch (err) {
                console.error('Error deleting message:', err);
            }
        }

        function openLightbox(element) {
            const img = element.querySelector('img');
            if (img) {
                const src = img.src;
                currentImageIndex = carouselImages.indexOf(src);
                updateLightboxImage();

                const lightboxModal = new bootstrap.Modal(document.getElementById('lightboxModal'));
                lightboxModal.show();
            }
        }

        function navigateLightbox(direction) {
            currentImageIndex += direction;
            if (currentImageIndex >= carouselImages.length) {
                currentImageIndex = 0;
            } else if (currentImageIndex < 0) {
                currentImageIndex = carouselImages.length - 1;
            }
            updateLightboxImage();
        }

        function updateLightboxImage() {
            const lightboxImage = document.getElementById('lightboxImage');
            if (lightboxImage) {
                lightboxImage.src = carouselImages[currentImageIndex];
            }
        }

        // Edit Message Function
        function openEditModal(nombre, mensaje) {
            document.getElementById('editOriginalName').value = nombre;
            document.getElementById('editNombre').value = nombre;
            document.getElementById('editMensaje').value = mensaje;

            const editModal = new bootstrap.Modal(document.getElementById('editMessageModal'));
            editModal.show();
        }
    </script>
</body>

</html>